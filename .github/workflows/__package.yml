name: Packaging ğŸ“¦

on:
  workflow_call:
    inputs:
      commit:
        required: false
        type: string
      tag_name:
        required: false
        type: string
      is_prerelease:
        required: false
        type: boolean
      push:
        required: false
        type: boolean
      architectures:
        description: As GitHub Actions doesn't support globals and/or arrays, you must pass this as an string, like '["amd64", "arm64"]'
        required: false
        type: string
        default: '["amd64", "arm64"]'

env:
  REGISTRY_IMAGE: jellyfin/jellyfin-vue
  RELEASE_TAG: stable
  PRERELEASE_TAG: stable-rc
  COMMIT_TAG: unstable
  DOCKER_BUILD_RECORD_UPLOAD: false

defaults:
  run:
    shell: bash

jobs:      
  tauri:
    name: Tauri for ${{ matrix.platform }} ğŸ–¥ï¸
    strategy:
      fail-fast: false
      matrix:
        platform:
          - MacOS
          - Ubuntu
          - Windows
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    env:
      WORKING_DIR: packaging/tauri
      ARTIFACTS_PATH: ${{
          format('target/release/{0}', matrix.platform == 'windows' && 'jellyfin-vue-tauri.exe' ||
          format('bundle/*/*.{0}', matrix.platform == 'macos' && 'dmg' || 'AppImage'))
        }}

    runs-on: ${{ matrix.platform }}-latest
    steps:
      - name: Checkout â¬‡ï¸
        uses: actions/checkout@v4.2.1
        with:
          ref: ${{ inputs.commit || github.sha }}
          show-progress: false

      - name: Setup node environment âš™ï¸
        uses: actions/setup-node@v4.0.4
        with:
          node-version: 20
          check-latest: true
          cache: 'npm'

      - name: Setup Rust Toolchain and cache ğŸ¦€
        uses: actions-rust-lang/setup-rust-toolchain@v1.10.1
        with:
          cache-key: tauri-${{ runner.os }}
          cache-workspaces: ${{ env.WORKING_DIR }}

      - name: Install npm dependencies ğŸ“¦
        run: npm ci --no-audit

      - name: Install Linux dependencies ğŸ“¦ğŸ§
        if: ${{ matrix.platform == 'ubuntu' }}
        run: |
          sudo apt update -qq
          sudo apt install -y --no-install-recommends $(cat apt_packages)

      - name: Build application ğŸ› ï¸
        run: npm run build

      - name: Create provenance attestation ğŸ”
        uses: actions/attest-build-provenance@v1.4.3
        continue-on-error: true
        with:
          subject-path: ${{ env.WORKING_DIR }}/${{ env.ARTIFACTS_PATH }}

      - name: Upload built application artifact â¬†ï¸ğŸ§ğŸğŸªŸ
        uses: actions/upload-artifact@v4.4.3
        with:
          compression-level: 0
          name: jellyfin-vue_${{ runner.os }}
          path: ${{ env.WORKING_DIR }}/${{ env.ARTIFACTS_PATH }}

  docker_inputs:
    name: Prepare Docker build variables ğŸ·ï¸ğŸ³
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ env.tags }}
      platforms: ${{ env.platforms }}
      caches: ${{ env.caches }}

    # EOF is needed for multiline environment variables in a GitHub Actions context
    steps:
      - name: Get current date âŒ›
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Parse commit hash âš™ï¸
        if: ${{ inputs.commit != '' }}
        id: sha
        run: |
          PARSEABLE_SHA='${{ inputs.commit }}'
          echo "sha=${PARSEABLE_SHA::7}" >> $GITHUB_OUTPUT

      ## How tags are assigned:
      ## - 1Âº block: Handle 'stable' release: No commit, is_prerelease=false
      ## - 2Âº block: Handle 'stable-rc' release: No commit, is_prerelease=true
      ## - 3Âº block: Handle 'unstable' release: Has commit hash
      #
      ## Before setting as output, we remove the blank lines
      - name: Generate tags ğŸ·ï¸
        run: |
          TG='${{ inputs.commit == '' && !inputs.is_prerelease && format('{0}:{1}', env.REGISTRY_IMAGE, 'latest') || '' }}\n'
          TG+='${{ inputs.commit == '' && !inputs.is_prerelease && format('{0}:{1}', env.REGISTRY_IMAGE, env.RELEASE_TAG) || '' }}\n'
          TG+='${{ inputs.commit == '' && !inputs.is_prerelease && inputs.tag_name && format('{0}:{1}.{2}', env.REGISTRY_IMAGE, env.RELEASE_TAG, inputs.tag_name) || '' }}\n'
          TG+='${{ inputs.commit == '' && !inputs.is_prerelease && format('ghcr.io/{0}:{1}', env.REGISTRY_IMAGE, 'latest') || '' }}\n'
          TG+='${{ inputs.commit == '' && !inputs.is_prerelease && format('ghcr.io/{0}:{1}', env.REGISTRY_IMAGE, env.RELEASE_TAG) || '' }}\n'
          TG+='${{ inputs.commit == '' && !inputs.is_prerelease && inputs.tag_name && format('ghcr.io/{0}:{1}.{2}', env.REGISTRY_IMAGE, env.RELEASE_TAG, inputs.tag_name) || '' }}\n'

          TG+='${{ inputs.commit == '' && inputs.is_prerelease && format('{0}:{1}', env.REGISTRY_IMAGE, env.PRERELEASE_TAG) || '' }}\n'
          TG+='${{ inputs.commit == '' && inputs.is_prerelease && inputs.tag_name && format('{0}:{1}.{2}', env.REGISTRY_IMAGE, env.PRERELEASE_TAG, inputs.tag_name) || '' }}\n'
          TG+='${{ inputs.commit == '' && inputs.is_prerelease && format('ghcr.io/{0}:{1}', env.REGISTRY_IMAGE, env.PRERELEASE_TAG) || '' }}\n'
          TG+='${{ inputs.commit == '' && inputs.is_prerelease && inputs.tag_name && format('ghcr.io/{0}:{1}.{2}', env.REGISTRY_IMAGE, env.PRERELEASE_TAG, inputs.tag_name) || '' }}\n'

          TG+='${{ inputs.commit != '' && format('{0}:{1}', env.REGISTRY_IMAGE, env.COMMIT_TAG) || '' }}\n'
          TG+='${{ inputs.commit != '' && format('{0}:{1}.{2}.{3}', env.REGISTRY_IMAGE, env.COMMIT_TAG, steps.date.outputs.date, steps.sha.outputs.sha) || '' }}\n'
          TG+='${{ inputs.commit != '' && format('ghcr.io/{0}:{1}', env.REGISTRY_IMAGE, env.COMMIT_TAG) || '' }}\n'
          TG+='${{ inputs.commit != '' && format('ghcr.io/{0}:{1}.{2}.{3}', env.REGISTRY_IMAGE, env.COMMIT_TAG, steps.date.outputs.date, steps.sha.outputs.sha) || '' }}'
          echo "tags<<EOF" >> $GITHUB_ENV
          echo -e "$TG" | tr -s '\n' >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Generate platform array ğŸ–¥ï¸ğŸ“
        run: |
          PARSED_ARRAY=$(echo '${{ inputs.architectures }}' | jq '. | map("linux/" + .) | .[]' | tr -d '"')
          echo "platforms<<EOF" >> $GITHUB_ENV
          echo "$PARSED_ARRAY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Generate cache array ğŸ’¾ğŸ“
        run: |
          PARSED_ARRAY=$(echo '${{ inputs.architectures }}' | jq '. | map("type=local,mode=min,src=/tmp/${{ env.REGISTRY_IMAGE }}/cache/buildx-" + .) | .[]' | tr -d '"')
          echo "caches<<EOF" >> $GITHUB_ENV
          echo "$PARSED_ARRAY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

  docker:
    name: Docker image for ${{ matrix.platform }} ğŸ’¿ğŸ³
    runs-on: ubuntu-latest
    needs: docker_inputs
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(inputs.architectures) }}

    steps:
      - name: Checkout â¬‡ï¸
        uses: actions/checkout@v4.2.1
        with:
          ref: ${{ inputs.commit || github.sha }}
          show-progress: false

      - name: Configure QEMU âš™ï¸
        uses: docker/setup-qemu-action@v3.2.0

      - name: Configure Docker Buildx âš™ï¸
        uses: docker/setup-buildx-action@v3.7.1

      - name: Build images ğŸ› ï¸
        uses: docker/build-push-action@v6.9.0
        id: image
        with:
          context: .
          file: packaging/docker/Dockerfile
          platforms: ${{ format('linux/{0}', matrix.platform) }}
          cache-from: |
            type=gha,scope=buildx-${{ matrix.platform }}
          cache-to: |
            type=local,mode=min,dest=/tmp/${{ env.REGISTRY_IMAGE }}/cache/${{ matrix.platform }}
            type=gha,mode=min,ignore-error=true,scope=buildx-${{ matrix.platform }}
          outputs: type=docker,dest=docker_image.tar
          build-args: |
            ${{ inputs.commit == '' && 'IS_STABLE=1' || '' }}
            ${{ inputs.commit != '' && format('COMMIT_HASH={0}', inputs.commit) || '' }}
          tags: |
            ${{ needs.docker_inputs.outputs.tags }}

      - name: Upload Docker image as artifact â¬†ï¸ğŸ“¦
        uses: actions/upload-artifact@v4.4.3
        with:
          compression-level: 0
          name: docker_image-linux_${{ matrix.platform }}
          path: docker_image.tar

      - name: Create provenance attestation ğŸ”
        uses: actions/attest-build-provenance@v1.4.3
        continue-on-error: true
        with:
          subject-path: docker_image.tar

      - name: Upload cache artifact â¬†ï¸âš™ï¸
        uses: actions/upload-artifact@v4.4.3
        if: ${{ inputs.push }}
        with:
          compression-level: 0
          name: buildx-${{ matrix.platform }}
          path: |
            /tmp/${{ env.REGISTRY_IMAGE }}/cache/${{ matrix.platform }}

  frontend:
    name: Publish frontend artifact ğŸš€
    runs-on: ubuntu-latest
    needs: docker

    steps:         
      - name: Download Docker image artifact ğŸ“¦â¬‡ï¸
        uses: actions/download-artifact@v4.1.8
        with:
          name: docker_image-linux_amd64

      - name: Extract built client from Docker image ğŸ—œï¸
        run: |
          docker load < docker_image.tar
          docker cp $(docker create --name jf $(docker images --filter=reference='${{ env.REGISTRY_IMAGE }}' -q | head -n 1)):/usr/share/nginx/html/ ./dist

      - name: Create provenance attestation ğŸ”
        uses: actions/attest-build-provenance@v1.4.3
        continue-on-error: true
        with:
          subject-path: dist

      - name: Upload client artifact â¬†ï¸ğŸ’»
        uses: actions/upload-artifact@v4.4.3
        with:
          compression-level: 0
          name: frontend
          path: dist

  docker_merge:
    name: Merge Docker images ğŸ’¿ğŸ³
    runs-on: ubuntu-latest
    if: ${{ inputs.push }}
    needs:
      - docker
      - docker_inputs

    steps:
      - name: Download cache artifacts ğŸ“¦â¬‡ï¸
        uses: actions/download-artifact@v4.1.8
        with:
          pattern: buildx-*
          path: /tmp/${{ env.REGISTRY_IMAGE }}/cache/
  
      - name: Checkout â¬‡ï¸
        uses: actions/checkout@v4.2.1
        with:
          ref: ${{ inputs.commit || github.sha }}
          show-progress: false

      - name: Configure QEMU âš™ï¸
        uses: docker/setup-qemu-action@v3.2.0

      - name: Configure Docker Buildx âš™ï¸
        uses: docker/setup-buildx-action@v3.7.1

      - name: Login to Docker Hub ğŸ”‘
        uses: docker/login-action@v3.3.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry ğŸ”‘
        uses: docker/login-action@v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.JF_BOT_TOKEN }}

      - name: Create multiplatform image ${{ inputs.push && 'and push ğŸ› ï¸â¬†ï¸' || 'ğŸ› ï¸' }} 
        uses: docker/build-push-action@v6.9.0
        id: image
        with:
          context: .
          file: packaging/docker/Dockerfile
          push: true
          provenance: mode=max
          sbom: true
          cache-from: |
            ${{ needs.docker_inputs.outputs.caches }}
          platforms: |
            ${{ needs.docker_inputs.outputs.platforms }}
          build-args: |
            ${{ inputs.commit == '' && 'IS_STABLE=1' || '' }}
            ${{ inputs.commit != '' && format('COMMIT_HASH={0}', inputs.commit) || '' }}
          tags: |
            ${{ needs.docker_inputs.outputs.tags }}

      - name: Remove cache artifacts ğŸ—‘ï¸
        uses: geekyeggo/delete-artifact@v5.1.0
        with:
          name: |
            buildx-*
